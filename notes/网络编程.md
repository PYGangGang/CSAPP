# 网络编程 / Network

**网络的基本概念**

---

[1] 客户端-服务端编程模型（C/S）

客户端需要服务时，向服务端发送一个请求，发起一个事务（transaction）；服务端接到请求后，解释并操作其上的资源；服务端给客户端发送一个响应，并等待下一个请求；客户端收到响应并处理它。

[2] 网络

对于主机而言，网络是是一种特殊的 I/O 设备。

从物理上讲，网络由下到上可以是：局域网（LAN, Local Area Network） -> 路由器（Router） -> 互联网（internet）；最流行的局域网技术是以太网（Ethernet），它由主机 -> 集线器 -> 网桥 构成。这里《CS: APP》也没有展开，留到计网慢慢看吧。互联网用**协议软件**来规整不同局域网的兼容问题，只需要记住，**互联网思想的精髓：封装**。

[3] TCP/IP 协议族

IP 协议提供基本得命名方法和递送机制，它是不可靠的；UDP 协议就是在 IP 协议上包了一层，使之能够进行进程间通信而非主机间通信，它也是不可靠得；TCP 协议是一个构建在 IP 协议上的复杂协议，它提供可靠的全双工通信。*这里也不细讲了*

[4] IP 地址（此处只讨论 IPV4）

一个 IP 地址就是一个 32 位的无符号整数，它唯一地标明了世界上的某台主机（当然 IPV4 不够的情况下，它也不一定是值一台主机，暂不讨论）；TCP/IP 将任意整数数据定义为大端表示法，在 Unix 中，可以用 htonl, htons, ntohl, ntohs 系统调用调整。

```cpp
// IP 地址的结构
struct in_addr {
    uint32_t s_addr;
}
```

IP 地址的表示通常用*点分十进制表示法*，及每个字节用其十进制表示，并用 **.** 分隔每个字节。用 inet_pton 和 inet_ntop 来在两种表示方法间转换。

```cpp
128.2.194.242 : 0x8002c2f2
```

[5] 域名（domain name）

域名就是 一个名字 -> IP 地址 的一个映射关系，由 DNS 维护（1988年以前是自己维护一个 HOSTS.TXT 文档）。可以使用 nslookup 来查域名。

* 一级域名：com, edu, gov, org, net 等
  * 由非盈利组织 ICANN 定义
* 二级域名：cmu, mit, berkeley, baidu 等
  * 由授权代理按先来后到分配
* 三级域名：有了二级域名之后，再往下的子域名就可以自己随便加了

[6] 因特网连接（此处指 TCP 连接）

一个连接由一个 socket pair 唯一确定，而客户端和服务端的 socket 地址由 IP : port 确定（port 为 16 位无符号整数）；用一个四元组表示一个连接如下：

```cpp
(client_addr, client_port, server_addr, server_port)
// 所以，理论上一个服务端进程可以有多少个 TCP 连接呢？
// 2^32 * 2^16 * 1 * 2^16 这么多个！
```

**socket 接口 —— 对于一般程序员来说最底层的网络编程**

---

从 Linux 内核来看，一个 socket 就是通信的一个端点；从 Linux 程序来看，socket 就是一个有相应描述符的打开文件。

socket 存放在如下数据结构里：

```cpp
// 一般的
struct sockaddr_in {
    uint16_t        sin_family; // 协议（对于因特网，始终为 AF_INET）
    uint16_t        sin_port; // 端口
    struct in_addr  sin_addr; // IP 地址
    unsigned char   sin_zero[8]; // padding
}
// 通用类型：为了在 connect, bind, accept 中指定协议
struct sockaddr {
    uint16_t sa_family; // 协议
    char sa_data[14]; // 地址信息，这么多怎么都够存了
}
```



**Web 服务器的基本概念 —— 不用库用 sockect 写 web 的思路**

---



**综合例子：TINY Web 服务器**

---



**小结**

---

